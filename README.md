# Gray Cubes (v0.4.0)

![Gameplay GIF](https://github.com/jing3r/jing3r/blob/main/GrayCubes.gif?raw=true) 

---
## ▶️ [Играть в браузере (на itch.io)](https://jing3r.itch.io/graycubes)
---

Проект представляет собой платформу для прототипирования механик сеточных головоломок на Unity. Основной фокус при разработке был сделан на создании масштабируемой, слабосвязанной архитектуры и решении сопутствующих технических задач.

## Архитектура и ключевые решения

Проект построен на основе MVC-подобной архитектуры с четким разделением ответственности между компонентами.

### 1. Разделение ответственности (SRP)

Монолитный класс `GameManager` был разделен на три независимых системных контроллера:
*   **`GameManager`:** Высокоуровневый координатор. Управляет жизненным циклом игровых режимов (`Sandbox`, `Match3`), инициализирует системы и предоставляет публичный API для UI и систем сохранения.
*   **`InputController`:** Обрабатывает пользовательский ввод (`Input`). Преобразует нажатия клавиш в вызовы команд в `GameManager`, полностью отделяя логику ввода от игровой логики.
*   **`ActionController`:** Оркестратор асинхронных действий. Управляет выполнением игровых команд (перемещение, вращение), используя корутины для контроля последовательности анимаций и предотвращения "гонки состояний".

### 2. Модель данных и управление состоянием

*   **`GameBoard`:** Центральный элемент модели данных. Класс, не являющийся `MonoBehaviour`, который представляет собой логическую сетку и является "единственным источником правды" о расположении кубов. Инкапсулирует всю логику преобразования координат.
*   **`CubeStateManager`:** Отвечает за сериализацию и десериализацию состояния. При сохранении создает "слепок" данных (`WorldState`), включающий состояние всех кубов, повороты и статистику. При загрузке полностью воссоздает сцену из данных, что гарантирует чистоту состояния.

### 3. Решение проблемы систем координат (World vs. Local Space)

Одной из ключевых задач была реализация механики вращения поля (`BoardContainer`), на котором расположены дочерние объекты-кубы. Это потребовало решения проблемы рассинхронизации между статической логической сеткой и вращающимся визуальным представлением.

*   **Централизация преобразований:** Все преобразования между мировыми координатами (`transform.position`) и логическими (`Vector2Int`) инкапсулированы в `GameBoard` (`GetWorldPosition`, `WorldToGridPosition`), который использует `TransformPoint` и `InverseTransformPoint` для корректных вычислений.
*   **Разделение векторов:**
    *   **Гравитация:** Реализована как внешняя, мировая сила. `Match3Controller` в каждый момент времени вычисляет ее проекцию на локальные оси повернутого `GameBoard`.
    *   **Управление:** `InputController` выполняет обратную операцию — преобразует намерение игрока (визуальное "вверх по экрану") в корректное направление для логической сетки с учетом ее текущего поворота.

## Реализованные механики и режимы

### "Песочница" (Sandbox)
Основной режим для демонстрации базовых механик манипуляции состоянием поля. В этом режиме поле всегда полностью заполнено.

*   **Выделение:** Одиночное, групповое (по связанной области или по категории грани), с модификаторами `Shift`/`Ctrl`.
*   **Манипуляции состоянием:**: все действия могут применяться как к выбранным кубам, так и к остальным кубам (через Shift), если не указано иное.
    *   **Относительное вращение:** Поворот выделенных кубов на 90° в любом из четырех направлений (`R`+`WASD`).
    *   **Абсолютное вращение:** Установка для выделенных кубов конкретной грани вверх (`F`+`1-6`).
    *   **Случайное вращение:** Установка случайного вращения для выделенных кубов (`G`).
    *   **Обмен состояний:** Обмен лицевыми гранями между двумя выделенными кубами (выбор обоих кубов -> `X`).
*   **Глобальные действия:**
    *   **Визуальное вращение поля:** Поворот всей доски (`Q`/`E`).
    
*   **Интегрированный модуль: Игра "Жизнь" Конвея:**
    *   Классический клеточный автомат, реализованный как отдельный, инкапсулированный модуль.
    *   Симуляция может быть запущена на основе любого созданного пользователем паттерна.
    *   Поддерживает зацикленный мир и отображает счетчик поколений.
    
### "Три в ряд" (Match-3)
Игровой режим, демонстрирующий применение базовых и продвинутых механик в рамках конкретных правил. В этом режиме на поле появляются пустые ячейки.

*   **Игровой цикл:** Реализован полный цикл: поиск матчей, уничтожение, каскадное падение, появление новых элементов.
*   **Механика "на выживание":** Появление одного нового куба за ход создает основное условие проигрыша — переполнение поля.
*   **Вращающаяся гравитация:** Поворот поля меняет направление автоматического падения кубов.
*   **Расширенный арсенал ходов:** Помимо стандартных действий, в этом режиме становятся доступны ходы, использующие пустое пространство:
    *   **Пошаговое перемещение (`Sokoban-style`):** Возможность "толкать" выделенные кубы в пустые ячейки (`V`+`WASD`).
    *   **Глобальный сдвиг (`2048-style`):** Смещение всех кубов до упора в одном из четырех направлений (`T`+`WASD`).
    *   **Г-образный прыжок:** Перемещение куба по диагонали вверх при условии, что клетка выше свободна (`V`+`W`->`A`/`D`).

## Как запустить
1.  Клонировать репозиторий.
2.  Открыть проект в Unity (2022.3.11f1).
3.  Запустить сцену `MainScene` из папки `Assets/Scenes`.
